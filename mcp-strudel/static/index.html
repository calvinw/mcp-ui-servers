<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strudel MCP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SESSION_ID_PLACEHOLDER -->
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col p-3 md:p-6">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 md:mb-6">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2 sm:mb-0">Strudel MCP</h1>
        <div class="flex items-center gap-4 text-sm">
            <div class="flex items-center gap-2">
                <div id="statusDot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                <span id="statusText" class="text-gray-700">Connecting to MCP server...</span>
            </div>
        </div>
    </div>
    
    <!-- Top Row: Sample Buttons on Left, Session ID on Right (Session ID first on mobile) -->
    <div class="flex flex-col lg:flex-row gap-4 mb-4">
        <!-- Session ID Section - Shows first on mobile -->
        <div class="w-full lg:w-80 order-1 lg:order-2">
            <div class="bg-blue-50 border border-blue-200 rounded p-3">
                <h3 class="text-sm md:text-base font-semibold text-blue-900 mb-2">Session ID</h3>
                <div class="flex items-center gap-2">
                    <div class="bg-white border border-blue-300 rounded px-2 py-1 flex-1">
                        <span id="sessionPhrase" class="text-sm font-mono text-blue-800 select-all">
                            Session Id: ----
                        </span>
                    </div>
                    <button onclick="copySessionPhrase()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-1 px-2 rounded text-sm transition-all duration-200 hover:scale-105 touch-manipulation">
                        Copy
                    </button>
                </div>
                <p class="text-blue-700 text-xs md:text-sm mt-1">Share with your LLM to enable live coding</p>
            </div>
        </div>
        
        <!-- Sample Buttons Section -->
        <div class="flex-1 order-2 lg:order-1">
            <div class="text-xs md:text-sm text-gray-600 mb-2 font-semibold">üìö ELEMENTARY</div>
            <div class="flex flex-wrap gap-1 md:gap-2 mb-3">
                <button onclick="playPattern('simple_note')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Single note">
                    NOTE
                </button>
                <button onclick="playPattern('simple_drum')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Basic drums">
                    DRUM
                </button>
                <button onclick="playPattern('rest_pattern')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Using rests">
                    RESTS
                </button>
                <button onclick="playPattern('sequence')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Note sequence">
                    SEQUENCE
                </button>
                <button onclick="playPattern('parallel')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Parallel sounds">
                    PARALLEL
                </button>
                <button onclick="playPattern('speed_control')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Speed control">
                    SPEED
                </button>
                <button onclick="playPattern('sample_selection')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Sample selection">
                    SAMPLES
                </button>
                <button onclick="playPattern('basic_scale')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Using scales">
                    SCALE
                </button>
                <button onclick="playPattern('volume_control')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Volume control">
                    VOLUME
                </button>
                <button onclick="playPattern('simple_filter')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Basic filter">
                    FILTER
                </button>
            </div>
            
            <div class="text-xs md:text-sm text-gray-600 mb-2 font-semibold">üéì ADVANCED</div>
            <div class="flex flex-wrap gap-1 md:gap-2">
                <button onclick="playPattern('euclidean')" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Euclidean rhythms">
                    EUCLIDEAN
                </button>
                <button onclick="playPattern('layered_bass')" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Bass with effects">
                    BASS+
                </button>
                <button onclick="playPattern('arpeggio')" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Musical arpeggio">
                    ARPEGGIO
                </button>
                <button onclick="playPattern('chord_progression')" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Chord changes">
                    CHORDS
                </button>
                <button onclick="playPattern('polyrhythm')" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Multiple rhythms">
                    POLYRHYTHM
                </button>
                <button onclick="playPattern('filter_envelope')" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Filter envelope">
                    FILTER ENV
                </button>
                <button onclick="playPattern('sample_chopping')" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Sample chopping">
                    CHOPPING
                </button>
                <button onclick="playPattern('stack_demo')" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Stack multiple parts">
                    STACK
                </button>
                <button onclick="playPattern('effects_demo')" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Reverb and delay">
                    EFFECTS
                </button>
                <button onclick="playPattern('complex_stack')" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-1 px-2 md:py-1.5 md:px-3 rounded text-xs md:text-sm transition-all duration-200 hover:scale-105 touch-manipulation" title="Full composition">
                    COMPLEX
                </button>
            </div>
        </div>
    </div>
    
    <div class="flex-1">
        <!-- Play/Stop Controls Above Editor -->
        <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mb-2">
            <div class="flex gap-2 sm:gap-4">
                <button onclick="playCurrentCode()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 md:py-2 md:px-6 rounded text-sm transition-all duration-200 hover:scale-105 shadow-lg touch-manipulation">
                    ‚ñ∂ PLAY
                </button>
                <button onclick="stopAll()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 md:py-2 md:px-6 rounded text-sm transition-all duration-200 hover:scale-105 shadow-lg touch-manipulation">
                    ‚èπ STOP
                </button>
            </div>
            <div id="helpText" class="text-gray-800 text-base sm:text-lg font-bold hidden">Please hit Stop and then Play to initialize audio</div>
        </div>
        
        <div class="mb-4">
            <script src="https://unpkg.com/@strudel/repl@latest"></script>
            <strudel-repl id="strudelRepl" class="w-full h-96 block rounded-lg overflow-hidden shadow-lg">
                <!--
// Use buttons above or paste Strudel code here
silence
                -->
            </strudel-repl>
        </div>
    </div>
    
    <div id="messageLog" class="bg-gray-900 text-gray-500 p-3 md:p-4 rounded-lg h-16 md:h-20 overflow-y-auto font-mono text-xs md:text-sm mt-auto whitespace-pre-wrap">
        Sounds take about a minute to load...
    </div>

    <script>
        // Educational pattern definitions - progressive learning from basic to advanced
        const patterns = {
            // ELEMENTARY PATTERNS (10) - Learn the fundamentals
            simple_note: {
                code: 'note("c4")',
                description: "Single note - the most basic sound"
            },
            simple_drum: {
                code: 's("bd sd bd sd")',
                description: "Basic drum pattern - kick and snare"
            },
            rest_pattern: {
                code: 's("bd ~ sd ~")',
                description: "Using rests (~) to create rhythm and space"
            },
            sequence: {
                code: 'note("c d e f")',
                description: "Playing notes in sequence"
            },
            parallel: {
                code: 's("bd, hh*2")',
                description: "Playing sounds together with comma"
            },
            speed_control: {
                code: 's("hh*4")',
                description: "Speed things up with *4"
            },
            sample_selection: {
                code: 's("bd:0 bd:1 bd:2 bd:3")',
                description: "Choosing different samples with :number"
            },
            basic_scale: {
                code: 'n("0 2 4 7").scale("C:major").s("piano")',
                description: "Using scales - C major triad"
            },
            volume_control: {
                code: 's("bd sd").gain("0.8 0.4")',
                description: "Control volume with .gain()"
            },
            simple_filter: {
                code: 'note("c2 c3").s("sawtooth").lpf(800)',
                description: "Basic low-pass filter with .lpf()"
            },
            
            // ADVANCED PATTERNS (10) - Complex musical techniques
            euclidean: {
                code: 's("bd(3,8) sd(5,16) hh(13,16)").bank("RolandTR909")',
                description: "üåÄ Euclidean rhythms - distribute 3 kicks across 8 steps, etc."
            },
            layered_bass: {
                code: 'note("c1 eb1 f1 g1").s("sawtooth").lpf(sine.range(200,800).slow(4)).lpenv(3).room(0.2)',
                description: "üé∏ Bass with dynamic filter modulation and reverb"
            },
            arpeggio: {
                code: '"c a f e".off(1/8, add(7)).off(1/4, add(12)).note().s("triangle").slow(2)',
                description: "üéº Musical arpeggio with .off() creating harmonic delays"
            },
            chord_progression: {
                code: 'chord("<C^7 A7 Dm7 G7>").voicing().s("piano").room(0.4)',
                description: "üéπ Jazz chord progression with proper voicings"
            },
            polyrhythm: {
                code: 'stack(s("bd*3"), s("sd*5").late(1/8), s("hh*7").gain(0.3))',
                description: "ü•Å Multiple independent rhythms: 3/4 vs 5/4 vs 7/4 time"
            },
            filter_envelope: {
                code: 'note("c2 eb2 g2").s("sawtooth").lpf(400).lpa(0.1).lpd(0.2).lpenv(6).sometimes(add(note(12)))',
                description: "üéõÔ∏è Dynamic filter with ADSR envelope modulation"
            },
            sample_chopping: {
                code: 's("bd").chop(4).n("<0 2 1 3>")',
                description: "Chopping samples into slices"
            },
            stack_demo: {
                code: 'stack(s("bd ~ bd ~"), s("~ sd ~ sd"), s("hh*4").gain(0.5))',
                description: "Stack multiple patterns together"
            },
            effects_demo: {
                code: 'note("c4 g4 e4").s("triangle").room(0.5).delay(0.25)',
                description: "Atmospheric sounds with reverb and delay"
            },
            complex_stack: {
                code: `stack(
  // Bass
  note("c1 eb1 f1 g1").s("sawtooth").lpf(600).lpenv(4),
  // Melody
  n("0 2 4 <5 7>").scale("C4:minor").s("triangle").room(0.3),
  // Arpeggios
  "c5 eb5 g5".off(1/16, add(7)).note().s("square").gain(0.4),
  // Drums
  s("bd(3,8) sd(5,16) [~ hh]*8").bank("RolandTR909")
).slow(2)`,
                description: "üéº Complete composition: bass + melody + arpeggios + drums"
            }
        };

        // WebSocket connection for MCP
        let ws = null;
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const messageLog = document.getElementById('messageLog');

        function addLogEntry(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${message}\n`;
            messageLog.textContent += logLine;
            messageLog.scrollTop = messageLog.scrollHeight;
            
            // Keep only last 50 lines
            const lines = messageLog.textContent.split('\n');
            if (lines.length > 50) {
                messageLog.textContent = lines.slice(-50).join('\n');
            }
        }

        function updateConnectionStatus(connected) {
            const helpText = document.getElementById('helpText');
            if (connected) {
                statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                statusText.textContent = 'Connected to MCP server';
                helpText.classList.remove('hidden');
                
                // Hide help text after 60 seconds
                setTimeout(() => {
                    helpText.classList.add('hidden');
                }, 60000);
            } else {
                statusDot.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse';
                statusText.textContent = 'Disconnected from MCP server';
                helpText.classList.add('hidden');
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const sessionId = window.sessionId || 'unknown';
            const wsUrl = `${protocol}//${window.location.host}/ws?session_id=${sessionId}`;
            
            console.log('üîç Connecting WebSocket with sessionId:', sessionId);
            console.log('üîç WebSocket URL:', wsUrl);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                updateConnectionStatus(true);
                console.log('üîç WebSocket connected with URL:', wsUrl);
                addLogEntry('WebSocket connected to MCP server', 'success');
            };
            
            ws.onmessage = async function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('üîç WebSocket received message:', data);
                    
                    if (data.type === 'strudel-code') {
                        const description = data.metadata?.description || '';
                        const logMessage = description ? 
                            `Received: ${description}` : 
                            `Received: ${data.code.substring(0, 50)}...`;
                        
                        console.log('üéµ Processing strudel-code message:', data);
                        addLogEntry(logMessage);
                        
                        // Set the code and play it
                        setCustomCode(data.code);
                        
                    } else if (data.type === 'strudel-stop' || data.type === 'stop') {
                        addLogEntry('Received stop command');
                        stopAll();
                        
                    } else if (data.type === 'get-current-code') {
                        addLogEntry('Sending current editor code to MCP server');
                        sendCurrentCodeToServer(data.request_id);
                        
                    } else if (data.type === 'ping') {
                        ws.send(JSON.stringify({type: 'pong'}));
                        
                    } else {
                        addLogEntry(`Unknown message type: ${data.type}`);
                    }
                    
                } catch (error) {
                    console.error('WebSocket message error:', error);
                    addLogEntry(`Message parse error: ${error.message}`, 'error');
                }
            };
            
            ws.onclose = function() {
                updateConnectionStatus(false);
                addLogEntry('WebSocket disconnected, attempting to reconnect...', 'warning');
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                addLogEntry('WebSocket connection error', 'error');
            };
        }

        // Strudel control functions
        function playPattern(patternName) {
            const editor = document.getElementById('strudelEditor');
            if (!editor || !editor.editor) {
                addLogEntry('Editor not ready yet', 'error');
                return;
            }

            const pattern = patterns[patternName];
            if (!pattern) {
                addLogEntry(`Pattern not found: ${patternName}`, 'error');
                return;
            }

            addLogEntry(`Playing ${patternName}: ${pattern.description}`);
            setCustomCode(pattern.code);
        }

        function playCurrentCode() {
            const repl = document.getElementById('strudelRepl');
            if (!repl || !repl.editor) {
                addLogEntry('REPL not ready yet', 'error');
                return;
            }

            addLogEntry('Playing current code');

            try {
                repl.editor.evaluate();
                addLogEntry(' Playing current code');
            } catch (e) {
                addLogEntry(` Evaluation failed: ${e.message}`, 'error');
            }
        }

        function stopAll() {
            const repl = document.getElementById('strudelRepl');
            if (!repl || !repl.editor) {
                addLogEntry('REPL not ready yet', 'error');
                return;
            }

            try {
                repl.editor.stop();
                addLogEntry(' Stopped all patterns');
            } catch (e) {
                addLogEntry(` Stop failed: ${e.message}`, 'error');
            }
        }

        function setCustomCode(code) {
            const repl = document.getElementById('strudelRepl');
            if (!repl || !repl.editor) {
                addLogEntry('REPL not ready yet', 'error');
                return;
            }

            // Set the code using the editor property
            try {
                repl.editor.setCode(code);
                repl.editor.evaluate();
                addLogEntry(' Pattern playing');
            } catch (e) {
                addLogEntry(` Evaluation failed: ${e.message}`, 'error');
            }
        }

        function sendCurrentCodeToServer(requestId) {
            const repl = document.getElementById('strudelRepl');
            if (!repl || !repl.editor) {
                addLogEntry('REPL not ready for code retrieval', 'error');
                return;
            }

            // Get current code from the editor
            let currentCode = '';
            
            try {
                currentCode = repl.editor.getCode();
            } catch (e) {
                currentCode = '// Error retrieving code';
            }

            if (!currentCode || currentCode.trim() === '') {
                currentCode = '// No code in editor';
            }

            // Send the current code back to the server
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'current-code-response',
                    request_id: requestId,
                    code: currentCode,
                    timestamp: Date.now()
                };
                
                ws.send(JSON.stringify(message));
                addLogEntry(`Sent current code to MCP server (${currentCode.length} chars)`);
                console.log('Current editor code:', currentCode);
            } else {
                addLogEntry('WebSocket not connected - cannot send code', 'error');
            }
        }

        // Global API for MCP compatibility
        window.strudel = {
            evaluate: async function(code) {
                setCustomCode(code);
                return Promise.resolve();
            },
            stop: async function() {
                stopAll();
                return Promise.resolve();
            }
        };

        // Enhanced API
        window.strudelControl = {
            playPattern,
            playCurrentCode,
            stopAll,
            setCustomCode
        };

        function copySessionPhrase() {
            const sessionPhrase = document.getElementById('sessionPhrase').textContent;
            if (sessionPhrase && !sessionPhrase.includes('----')) {
                navigator.clipboard.writeText(sessionPhrase).then(() => {
                    addLogEntry(`Session phrase copied to clipboard: "${sessionPhrase}"`);
                    
                    // Visual feedback
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    button.className = button.className.replace('bg-blue-600 hover:bg-blue-700', 'bg-green-600 hover:bg-green-700');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = button.className.replace('bg-green-600 hover:bg-green-700', 'bg-blue-600 hover:bg-blue-700');
                    }, 2000);
                }).catch(() => {
                    addLogEntry('Failed to copy session phrase', 'error');
                });
            }
        }

        // Initialize WebSocket connection when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Display session ID and phrase
            if (window.sessionId) {
                const sessionCode = window.sessionId.toLowerCase();
                const sessionPhrase = `Session Id: ${sessionCode}`;
                document.getElementById('sessionPhrase').textContent = sessionPhrase;
                addLogEntry(`Session ready: ${sessionCode.toUpperCase()}`);
            }
            
            addLogEntry('Strudel MCP interface ready');
            connectWebSocket();
            
            // Load starter pattern after a brief delay
            setTimeout(() => {
                const starterCode = `stack(
  note("c2 eb2 g2 bb2").s("sawtooth").lpf(400).slow(2),
  note("c4 d4 eb4 f4 g4 ab4 bb4 c5").s("triangle").gain(0.7),
  s("bd ~ bd ~").fast(1.5)
)`;
                setCustomCode(starterCode);
                addLogEntry('Loaded starter pattern');
                
            }, 1000);
        });

        console.log(' Strudel MCP Live Coding ready!');
    </script>
</body>
</html>